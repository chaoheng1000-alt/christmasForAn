---
import GiftBox from "../GiftBox.astro";
import ImageModal from "../ImageModal.astro";
import ChristmasMusic from "../ChristmasMusic.astro";
import { giftBoxes, backgroundMusic } from "../christmasConfig";

// è·å– base URLï¼Œç”¨äºå¤„ç†é™æ€èµ„æºè·¯å¾„
// ç¡®ä¿è·¯å¾„æ­£ç¡®åŒ…å« base
const baseUrl = import.meta.env.BASE_URL;
// ç¡®ä¿ baseUrl ä»¥ / ç»“å°¾ï¼ˆé™¤éæ˜¯æ ¹è·¯å¾„ï¼‰
const normalizedBase = baseUrl === '/' ? '' : (baseUrl.endsWith('/') ? baseUrl : baseUrl + '/');
const treeImageUrl = `${normalizedBase}assets/tree.jpg`;

// åˆ›å»ºç¤¼ç›’IDåˆ°å›¾ç‰‡è·¯å¾„çš„æ˜ å°„ï¼Œä¾›å®¢æˆ·ç«¯ä½¿ç”¨
const giftImageMap: Record<string, string> = {};
giftBoxes.forEach(gift => {
	giftImageMap[gift.id] = gift.image;
});
const giftImageMapJson = JSON.stringify(giftImageMap);
---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>åœ£è¯ä¸»é¢˜é¡µé¢</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

	body {
		font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
		background-color: #4E2122; /* å¤‡ç”¨èƒŒæ™¯è‰²ï¼Œå›¾ç‰‡åŠ è½½å‰çš„å ä½ */
		min-height: 100vh;
		overflow-x: hidden;
		position: relative;
	}

	/* æ·»åŠ èƒŒæ™¯å…‰æ•ˆï¼ˆå¯é€‰ï¼Œå¦‚æœéœ€è¦å¯ä»¥ä¿ç•™ï¼‰ */
	body::before {
		content: '';
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: 
			radial-gradient(circle at 20% 30%, rgba(255, 215, 0, 0.05) 0%, transparent 40%),
			radial-gradient(circle at 80% 70%, rgba(255, 100, 50, 0.03) 0%, transparent 40%);
		pointer-events: none;
		z-index: 0;
		animation: background-shimmer 8s ease-in-out infinite;
	}

	@keyframes background-shimmer {
		0%, 100% {
			opacity: 1;
		}
		50% {
			opacity: 0.7;
		}
	}


	/* é›ªèŠ±åŠ¨ç”» - å¢å¼ºæ•ˆæœ */
	.snowflakes {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		pointer-events: none;
		z-index: 2;
		overflow: hidden;
	}

	.snowflake {
		position: absolute;
		color: #fff;
		font-size: 1em;
		font-family: Arial, sans-serif;
		text-shadow: 0 0 10px rgba(255, 255, 255, 0.9), 0 0 20px rgba(255, 255, 255, 0.5);
		animation: snowfall linear infinite;
		opacity: 0.9;
		font-weight: bold;
	}

	.snowflake.small {
		font-size: 0.8em;
		opacity: 0.7;
	}

	.snowflake.medium {
		font-size: 1.2em;
		opacity: 0.85;
	}

	.snowflake.large {
		font-size: 1.5em;
		opacity: 0.95;
	}

	@keyframes snowfall {
		0% {
			transform: translateY(-10vh) translateX(0) rotate(0deg);
			opacity: 0;
		}
		10% {
			opacity: 0.9;
		}
		50% {
			transform: translateY(50vh) translateX(15px) rotate(180deg);
		}
		90% {
			opacity: 0.9;
		}
		100% {
			transform: translateY(110vh) translateX(-15px) rotate(360deg);
			opacity: 0;
		}
	}

		/* ä¸»å®¹å™¨ */
		.main-container {
			position: relative;
			width: 100%;
			min-height: 100vh;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			padding: 20px;
			z-index: 3;
		}

		/* æ ‡é¢˜ */
		.page-title {
			color: #fff;
			font-size: 2.5rem;
			margin-bottom: 30px;
			text-align: center;
			text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
			animation: title-glow 2s ease-in-out infinite;
		}

		@keyframes title-glow {
			0%, 100% {
				text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
			}
			50% {
				text-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.6);
			}
		}

		/* åœºæ™¯å®¹å™¨ */
		.scene-container {
			position: relative;
			width: 100%;
			max-width: 1200px;
			height: 80vh;
			min-height: 600px;
			background: radial-gradient(ellipse at center, rgba(255, 215, 0, 0.05) 0%, transparent 70%);
			border-radius: 20px;
			padding: 20px;
		}

		/* å“åº”å¼è®¾è®¡ */
		@media (max-width: 768px) {
			.page-title {
				font-size: 1.8rem;
				margin-bottom: 20px;
			}

			.scene-container {
				height: 70vh;
				min-height: 500px;
			}
		}
	</style>
</head>
<body style={`background: url('${treeImageUrl}') center center / cover no-repeat fixed;`}>
	<!-- é›ªèŠ±åŠ¨ç”» -->
	<div class="snowflakes" id="snowflakes"></div>

	<!-- ä¸»å®¹å™¨ -->
	<div class="main-container">
		<h1 class="page-title">ğŸ„ åœ£è¯å¿«ä¹ ğŸ„</h1>
		
		<!-- åœºæ™¯å®¹å™¨ -->
		<div class="scene-container">
			<!-- ç¤¼ç›’ -->
			{giftBoxes.map((gift) => (
				<GiftBox gift={gift} />
			))}
		</div>
	</div>

	<!-- å›¾ç‰‡æ¨¡æ€æ¡† -->
	<ImageModal imageUrl="" onClose="window.closeImageModal" />

	<!-- èƒŒæ™¯éŸ³ä¹ -->
	<ChristmasMusic musicUrl={backgroundMusic} />

	<script define:vars={{ giftImageMapJson }}>
		// ç”Ÿæˆé›ªèŠ± - å¢å¼ºç‰ˆ
		function createSnowflakes() {
			const snowflakesContainer = document.getElementById('snowflakes');
			if (!snowflakesContainer) return;

			const snowflakeSymbols = ['â„', 'â…', 'â†', 'âœ»', 'âœ¼', 'â‰', 'âœ¦', 'âœ§'];
			const numSnowflakes = 80; // å¢åŠ é›ªèŠ±æ•°é‡

			for (let i = 0; i < numSnowflakes; i++) {
				const snowflake = document.createElement('div');
				const size = Math.random();
				if (size < 0.33) {
					snowflake.className = 'snowflake small';
				} else if (size < 0.66) {
					snowflake.className = 'snowflake medium';
				} else {
					snowflake.className = 'snowflake large';
				}
				
				snowflake.textContent = snowflakeSymbols[Math.floor(Math.random() * snowflakeSymbols.length)];
				snowflake.style.left = Math.random() * 100 + '%';
				const fallDuration = (Math.random() * 5 + 3) + 's';
				const delay = Math.random() * 5 + 's';
				snowflake.style.animation = `snowfall ${fallDuration} linear ${delay} infinite`;
				
				snowflakesContainer.appendChild(snowflake);
			}
		}

		// é¢œè‰²æå–å·¥å…·ï¼ˆç”¨äºæå–å›¾ç‰‡èƒŒæ™¯è‰²ï¼‰
		function extractImageColor() {
			const img = new Image();
			img.crossOrigin = 'anonymous';
			img.src = '{treeImageUrl}'; // treeImageUrl å·²ç»åŒ…å«äº† base URL
			img.onload = function() {
				const canvas = document.createElement('canvas');
				const ctx = canvas.getContext('2d');
				canvas.width = img.width;
				canvas.height = img.height;
				ctx.drawImage(img, 0, 0);
				
				// ä»å›¾ç‰‡å››ä¸ªè§’è½é‡‡æ ·é¢œè‰²
				const corners = [
					[0, 0], // å·¦ä¸Š
					[img.width - 1, 0], // å³ä¸Š
					[0, img.height - 1], // å·¦ä¸‹
					[img.width - 1, img.height - 1] // å³ä¸‹
				];
				
				const colors = corners.map(([x, y]) => {
					const pixel = ctx.getImageData(x, y, 1, 1).data;
					return `rgb(${pixel[0]}, ${pixel[1]}, ${pixel[2]})`;
				});
				
				// è®¡ç®—å¹³å‡é¢œè‰²
				const avgColor = corners.reduce((acc, [x, y]) => {
					const pixel = ctx.getImageData(x, y, 1, 1).data;
					return {
						r: acc.r + pixel[0],
						g: acc.g + pixel[1],
						b: acc.b + pixel[2]
					};
				}, { r: 0, g: 0, b: 0 });
				
				const avgR = Math.round(avgColor.r / 4);
				const avgG = Math.round(avgColor.g / 4);
				const avgB = Math.round(avgColor.b / 4);
				
				// è½¬æ¢ä¸ºåå…­è¿›åˆ¶
				const hex = '#' + [avgR, avgG, avgB].map(x => {
					const hex = x.toString(16);
					return hex.length === 1 ? '0' + hex : hex;
				}).join('');
				
				console.log('æå–çš„èƒŒæ™¯é¢œè‰²:', hex, `rgb(${avgR}, ${avgG}, ${avgB})`);
				console.log('è§’è½é¢œè‰²:', colors);
				
				// å¯ä»¥åœ¨è¿™é‡Œè‡ªåŠ¨æ›´æ–°èƒŒæ™¯è‰²
				// document.body.style.background = `linear-gradient(180deg, ${hex} 0%, ${hex}dd 50%, ${hex}bb 100%)`;
			};
		}

		// ç¤¼ç›’ç‚¹å‡»äº‹ä»¶
		document.addEventListener('DOMContentLoaded', () => {
			createSnowflakes();
			// å–æ¶ˆæ³¨é‡Šä¸‹é¢è¿™è¡Œæ¥æå–å›¾ç‰‡èƒŒæ™¯è‰²
			// extractImageColor();

			// ä»æœåŠ¡ç«¯é…ç½®è·å–å›¾ç‰‡è·¯å¾„æ˜ å°„
			const giftImageMap = JSON.parse(giftImageMapJson);

			const giftBoxes = document.querySelectorAll('.gift-box');
			giftBoxes.forEach((box) => {
				box.addEventListener('click', () => {
					const giftId = box.getAttribute('data-gift-id');
					if (giftId && window.showImageModal) {
						// ä»é…ç½®ä¸­è·å–å›¾ç‰‡è·¯å¾„
						const imageUrl = giftImageMap[giftId];
						if (imageUrl) {
							window.showImageModal(imageUrl);
						}
					}
					
					// æ·»åŠ ç‚¹å‡»åŠ¨ç”»
					box.classList.add('animating');
					setTimeout(() => {
						box.classList.remove('animating');
					}, 500);
				});
			});
		});
	</script>
</body>
</html>
